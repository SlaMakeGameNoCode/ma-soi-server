<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ma S√≥i Mobile - Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .card {
            background: #1e293b;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        h1,
        h2 {
            margin-bottom: 15px;
            text-align: center;
        }

        .hidden {
            display: none !important;
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: #3b82f6;
            color: #fff;
        }

        .btn-danger {
            background: #ef4444;
            color: #fff;
        }

        /* Inputs */
        input {
            width: 100%;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #334155;
            background: #0f172a;
            color: #fff;
            margin-bottom: 15px;
            font-size: 16px;
        }

        /* Lobby */
        .player-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #0f172a;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .online {
            background: #10b981;
        }

        .offline {
            background: #ef4444;
        }

        /* Game UI */
        .role-card {
            text-align: center;
            border: 2px solid #3b82f6;
            padding: 20px;
            background: #1e293b;
            margin-bottom: 20px;
        }

        .role-title {
            font-size: 24px;
            font-weight: bold;
            color: #fbbf24;
            margin-bottom: 5px;
        }

        .role-desc {
            color: #94a3b8;
            font-size: 14px;
        }

        .phase-indicator {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            padding: 10px;
            background: #334155;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        /* Action List */
        .action-list {
            display: grid;
            gap: 10px;
        }

        .action-btn {
            background: #0f172a;
            padding: 15px;
            border: 1px solid #334155;
            border-radius: 8px;
            color: #fff;
            text-align: left;
            cursor: pointer;
        }

        .action-btn.selected {
            border-color: #3b82f6;
            background: #1e3a8a;
        }

        /* Logs */
        #gameLogs {
            max-height: 150px;
            overflow-y: auto;
            font-size: 12px;
            color: #cbd5e1;
            padding: 10px;
            background: #0f172a;
            border-radius: 8px;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- JOIN SCREEN -->
        <div id="joinScreen">
            <div class="card" style="text-align: center;">
                <h1 style="font-size: 40px;">üê∫</h1>
                <h2>Ma S√≥i Mobile</h2>
                <input type="text" id="roomCodeInput" placeholder="M√£ Ph√≤ng" readonly>
                <input type="text" id="playerNameInput" placeholder="T√™n c·ªßa b·∫°n">
                <button class="btn btn-primary" id="joinBtn">Tham Gia</button>
            </div>
        </div>

        <!-- LOBBY SCREEN -->
        <div id="lobbyScreen" class="hidden">
            <div class="card">
                <h2>Ph√≤ng Ch·ªù</h2>
                <p style="text-align: center; color: #fbbf24; font-size: 20px; margin-bottom: 10px;" id="lobbyRoomCode">
                    ---</p>
                <div id="lobbyPlayerList"></div>
                <p style="text-align: center; color: #94a3b8; margin-top: 15px;">Ch·ªù Host b·∫Øt ƒë·∫ßu...</p>
            </div>
        </div>

        <!-- GAME SCREEN -->
        <div id="gameScreen" class="hidden">
            <!-- Role Info -->
            <div class="card role-card">
                <div class="role-title" id="roleName">---</div>
                <div class="role-desc" id="roleDesc">---</div>
            </div>

            <!-- Phase & Status -->
            <div class="phase-indicator" id="phaseDisplay">NIGHT 1</div>

            <!-- Action Area -->
            <div class="card" id="actionArea">
                <h3 id="actionTitle" style="margin-bottom: 10px;">H√†nh ƒê·ªông</h3>
                <div id="playerSelect" class="action-list"></div>
                <button class="btn btn-primary" id="confirmActionBtn" style="margin-top: 15px;">X√°c Nh·∫≠n</button>
            </div>

            <!-- Logs -->
            <div class="card">
                <h3>Th√¥ng B√°o</h3>
                <div id="gameLogs"></div>
            </div>
        </div>

        <!-- Narrator Notification Modal -->
        <div id="narratorOverlay" class="hidden"
            style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; display: flex; justify-content: center; align-items: center; flex-direction: column;">
            <div style="text-align: center; color: #fff; padding: 20px;">
                <h1 id="narTitle"
                    style="font-size: 32px; color: #fbbf24; margin-bottom: 20px; text-transform: uppercase; text-shadow: 0 0 10px #fbbf24;">
                    HELLO</h1>
                <p id="narMessage"
                    style="font-size: 20px; line-height: 1.5; color: #e2e8f0; max-width: 300px; margin: 0 auto;"></p>
                <button class="btn btn-primary" onclick="closeNarrator()"
                    style="margin-top: 40px; width: 200px; font-size: 18px;">OK</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        // State
        let myPlayerId = null;
        let myRole = null;
        let selectedTarget = null;
        let currentPlayers = [];
        let currentPhase = 'lobby';

        // DOM Elements
        const screens = {
            join: document.getElementById('joinScreen'),
            lobby: document.getElementById('lobbyScreen'),
            game: document.getElementById('gameScreen')
        };

        // URL Params
        const urlParams = new URLSearchParams(window.location.search);
        const roomCode = urlParams.get('room') || window.location.pathname.split('/join/')[1];
        if (roomCode) document.getElementById('roomCodeInput').value = roomCode;

        // --- HANDLERS ---

        document.getElementById('joinBtn').addEventListener('click', () => {
            const name = document.getElementById('playerNameInput').value;
            if (!name || !roomCode) return alert("Vui l√≤ng nh·∫≠p t√™n v√† m√£ ph√≤ng");

            socket.emit('JOIN_ROOM', { roomCode, playerName: name });
        });

        // --- SOCKET EVENTS ---

        socket.on('ROOM_CREATED', (data) => { // Handled same as Join for player
            myPlayerId = data.playerId;
            showScreen('lobby');
            document.getElementById('lobbyRoomCode').innerText = data.roomCode;
        });

        socket.on('PLAYER_JOINED', (data) => {
            currentPlayers = data.players;
            renderLobby(data.players);

            // If in game, refresh Action UI to reflect Alive statuses
            if (currentPhase !== 'lobby' && currentPhase !== 'end') {
                setupActionUI(currentPhase);
            }
        });

        socket.on('GAME_STARTED', (data) => {
            myRole = data.role;
            currentPlayers = data.players;
            currentPhase = 'night';

            // Get my name
            const me = currentPlayers.find(p => p.id === myPlayerId);
            const myName = me ? me.name : 'B·∫°n';

            showScreen('game');
            renderRole(data.role, myName);
            setupActionUI('night'); // Start at night
        });

        socket.on('PHASE_CHANGED', (data) => {
            currentPhase = data.phase;
            let phaseText = `${data.phase.toUpperCase()} ${data.day}`;
            if (data.phase === 'execution_reveal') phaseText = 'K·∫æT QU·∫¢ B·∫¶U C·ª¨';

            document.getElementById('phaseDisplay').innerText = phaseText;
            addTypesLogs(data.logs);

            // Sync players to define Alive status
            socket.emit('GET_PLAYERS');

            // Narrator Popups
            if (data.phase === 'day') {
                showNarrator('BAN NG√ÄY ‚òÄÔ∏è', `Tr·ªùi s√°ng r·ªìi!`);
            } else if (data.phase === 'vote') {
                showNarrator('B·ªé PHI·∫æU üó≥Ô∏è', 'M·ªçi ng∆∞·ªùi h√£y b·ªè phi·∫øu treo c·ªï!');
            } else if (data.phase === 'night') {
                showNarrator('BAN ƒê√äM üåô', `ƒê√™m th·ª© ${data.day}. C√°c ch·ª©c nƒÉng ho·∫°t ƒë·ªông!`);
            } else if (data.phase === 'end') {
                showNarrator('GAME OVER üèÅ', 'Tr√≤ ch∆°i k·∫øt th√∫c!');
            } else if (data.phase === 'execution_reveal') {
                showNarrator('K·∫æT QU·∫¢ ‚öñÔ∏è', 'ƒê√£ c√≥ k·∫øt qu·∫£ treo c·ªï...');
            }
        });

        socket.on('GAME_RESET', () => {
            showScreen('lobby');
            document.getElementById('gameLogs').innerHTML = ''; // Clear logs
            showNarrator('RESET', 'Host ƒë√£ reset game. ƒê√£ v·ªÅ l·∫°i ph√≤ng ch·ªù.');
        });

        socket.on('ERROR', (data) => alert(data.message));

        // --- NOTIFICATION ---
        const narratorOverlay = document.getElementById('narratorOverlay');
        function showNarrator(title, msg) {
            document.getElementById('narTitle').innerText = title;
            document.getElementById('narMessage').innerText = msg;
            narratorOverlay.classList.remove('hidden');
            narratorOverlay.style.display = 'flex';
        }

        window.closeNarrator = () => {
            narratorOverlay.classList.add('hidden');
            narratorOverlay.style.display = 'none';
        };

        // --- UI FUNCTIONS ---

        function showScreen(name) {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            screens[name].classList.remove('hidden');
        }

        function renderLobby(players) {
            const container = document.getElementById('lobbyPlayerList');
            container.innerHTML = players.map(p => `
                <div class="player-item">
                    <div class="status-dot ${p.connected ? 'online' : 'offline'}"></div>
                    <div>${p.name} ${p.isHost ? '(Host)' : ''}</div>
                </div>
            `).join('');
        }

        function renderRole(role, name) {
            const titles = {
                alphaWolf: 'S√≥i ƒê·∫ßu ƒê√†n üê∫',
                wolf: 'S√≥i Th∆∞·ªùng üê∫',
                detective: 'Th√°m T·ª≠ üïµÔ∏è',
                seer: 'Ti√™n Tri üîÆ',
                witch: 'Ph√π Th·ªßy üßô',
                hunter: 'Th·ª£ SƒÉn üèπ',
                lawyer: 'Lu·∫≠t S∆∞ ‚öñÔ∏è',
                traitor: 'K·∫ª Ph·∫£n B·ªôi üé≠',
                villager: 'D√¢n L√†ng üßë‚Äçüåæ'
            };
            const descs = {
                alphaWolf: 'Ch·ªçn m·ª•c ti√™u ƒë·ªÉ NGUN R·ª¶A (h·ªìi sinh + h√≥a s√≥i n·∫øu ch·∫øt b·ªüi s√≥i). C√πng s√≥i th∆∞·ªùng ch·ªçn m·ª•c ti√™u gi·∫øt.',
                wolf: 'Ch·ªçn m·ª•c ti√™u ƒë·ªÉ gi·∫øt v√†o ban ƒë√™m.',
                detective: 'Soi m·ªôt ng∆∞·ªùi ƒë·ªÉ bi·∫øt h·ªç c√≥ h√†nh ƒë·ªông ƒë√™m hay kh√¥ng.',
                seer: 'Soi m·ªôt ng∆∞·ªùi ƒë·ªÉ bi·∫øt h·ªç l√† S√≥i hay Ng∆∞·ªùi.',
                witch: 'C√≥ b√¨nh thu·ªëc ƒë·ªÉ GI·∫æT ng∆∞·ªùi ch∆°i kh√°c v√†o ban ƒë√™m.',
                hunter: 'N·∫øu b·ªã gi·∫øt ho·∫∑c treo c·ªï, danh t√≠nh s·∫Ω ƒë∆∞·ª£c c√¥ng b·ªë (v√† c√≥ th·ªÉ k√©o theo ng∆∞·ªùi kh√°c - T√πy Host).',
                lawyer: 'Ch·ªçn m·ªôt ng∆∞·ªùi ƒë·ªÉ b·∫£o v·ªá kh·ªèi √°n treo c·ªï ng√†y mai.',
                traitor: 'C·ªë g·∫Øng b·ªã treo c·ªï ho·∫∑c b·ªã s√≥i c·∫Øn ƒë√™m ƒë·∫ßu ƒë·ªÉ th·∫Øng.',
                villager: 'Ng·ªß v√† c·ªë g·∫Øng s·ªëng s√≥t.'
            };

            document.getElementById('roleName').innerText = `${name} - ${titles[role] || role}`;
            document.getElementById('roleDesc').innerText = descs[role] || '';
        }

        function setupActionUI(phase) {
            const container = document.getElementById('playerSelect');
            const title = document.getElementById('actionTitle');
            const btn = document.getElementById('confirmActionBtn');
            const actionArea = document.getElementById('actionArea');

            container.innerHTML = '';
            selectedTarget = null;
            btn.disabled = false;
            btn.innerText = 'X√ÅC NH·∫¨N';

            let showActions = false;
            let actionType = '';

            // Check Alive Status
            const me = currentPlayers.find(p => p.id === myPlayerId);
            if (!me || !me.alive) {
                // If dead, hide actions
                actionArea.classList.add('hidden');
                // Optional: Show "Spectating" status?
                // User said "ko b√°o tr·∫°ng th√°i ch·∫øt". 
                // So simply showing nothing (Spectator mode) is best.
                return;
            }

            if (phase === 'night') {
                if (['wolf', 'alphaWolf'].includes(myRole)) {
                    showActions = true;
                    title.innerHTML = 'Ch·ªçn m·ª•c ti√™u <br>' +
                        (myRole === 'alphaWolf' ?
                            '<div style="margin-top:10px; font-size:14px;"><label><input type="radio" name="wType" value="KILL" checked> KILL</label> <label style="margin-left:15px;"><input type="radio" name="wType" value="CURSE"> CURSE (1 time)</label></div>'
                            : '(KILL Only)');
                    actionType = 'KILL'; // Default

                    // Add listener for radio change
                    setTimeout(() => {
                        document.querySelectorAll('input[name="wType"]').forEach(r => {
                            r.onchange = (e) => actionType = e.target.value;
                        });
                    }, 100);
                } else if (myRole === 'detective') {
                    showActions = true;
                    title.innerText = 'Ch·ªçn ng∆∞·ªùi ƒë·ªÉ TH√ÅM T·ª¨ SOI (Ho·∫°t ƒë·ªông?)';
                    actionType = 'CHECK';
                } else if (myRole === 'seer') {
                    showActions = true;
                    title.innerText = 'Ch·ªçn ng∆∞·ªùi ƒë·ªÉ TI√äN TRI SOI (S√≥i/Ng∆∞·ªùi?)';
                    actionType = 'CHECK';
                } else if (myRole === 'witch') {
                    showActions = true;
                    title.innerText = 'Ch·ªçn ng∆∞·ªùi ƒë·ªÉ PH√ô TH·ª¶Y GI·∫æT (Kill Potion)';
                    // Witch Healing is complex, MVP only Kill
                    actionType = 'KILL';
                }
            } else if (phase === 'game' || phase === 'vote') { // Vote Phase
                showActions = true;
                title.innerText = 'B·ªè phi·∫øu treo c·ªï';
                actionType = 'VOTE';

                // Lawyer check
                if (myRole === 'lawyer') {
                    // Lawyer actually acts before vote, but simplified here
                    // Maybe add a special toggle for Lawyer?
                }
            }

            if (!showActions) {
                actionArea.classList.add('hidden');
                return;
            }
            actionArea.classList.remove('hidden');

            // Render targets (Alive players excluding self and Host)
            currentPlayers.filter(p => !p.isHost).forEach(p => {
                if (p.id === myPlayerId && actionType !== 'LAWYER_PROTECT') return; // Cannot target self usually

                const div = document.createElement('div');
                div.className = 'action-btn';
                div.innerText = p.name;
                div.onclick = () => {
                    document.querySelectorAll('.action-btn').forEach(b => b.classList.remove('selected'));
                    div.classList.add('selected');
                    selectedTarget = p.id;
                };
                container.appendChild(div);
            });

            btn.onclick = () => {
                if (!selectedTarget) return alert('Ch∆∞a ch·ªçn m·ª•c ti√™u!');

                if (actionType === 'VOTE') {
                    socket.emit('VOTE', { targetId: selectedTarget });
                } else {
                    // Start of complex role logic handling on client
                    // For Alpha Wolf, we might need 2 buttons (Kill/Curse)
                    // For MVP: Default to KILL. 
                    socket.emit('ACTION', { type: actionType, targetId: selectedTarget });
                }

                btn.disabled = true;
                btn.innerText = 'ƒê√£ G·ª≠i';
            };
        }

        function addTypesLogs(logs) {
            const container = document.getElementById('gameLogs');
            logs.forEach(msg => {
                const div = document.createElement('div');
                div.innerText = msg;
                container.prepend(div);
            });
        }
    </script>
</body>

</html>